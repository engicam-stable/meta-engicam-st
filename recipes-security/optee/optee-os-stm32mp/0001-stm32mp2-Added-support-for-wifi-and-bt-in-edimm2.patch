From 7219362baac23a0d6fcc96b7a98f69ae21959c5a Mon Sep 17 00:00:00 2001
From: FraUtel <francesco.utel@engicam.com>
Date: Wed, 4 Sep 2024 10:04:15 +0200
Subject: [PATCH] stm32mp2 - Added support for wifi and bt in edimm2

---
 core/arch/arm/dts/stm32mp257f-icore-edimm2-mx-rcc.dtsi | 1 +
 core/arch/arm/dts/stm32mp257f-icore-edimm2-mx-rif.dtsi | 8 ++++----
 core/arch/arm/dts/stm32mp257f-icore-edimm2-mx.dts      | 8 +++++++-
 3 files changed, 12 insertions(+), 5 deletions(-)

diff --git a/core/arch/arm/dts/stm32mp257f-icore-edimm2-mx-rcc.dtsi b/core/arch/arm/dts/stm32mp257f-icore-edimm2-mx-rcc.dtsi
index 6a9f39f6f..ddd102e0b 100644
--- a/core/arch/arm/dts/stm32mp257f-icore-edimm2-mx-rcc.dtsi
+++ b/core/arch/arm/dts/stm32mp257f-icore-edimm2-mx-rcc.dtsi
@@ -71,6 +71,7 @@
 		FLEXGEN_CFG(45, XBAR_SRC_PLL4, 0, 2)
 		FLEXGEN_CFG(51, XBAR_SRC_PLL4, 0, 5)
 		FLEXGEN_CFG(52, XBAR_SRC_PLL4, 0, 5)
+		FLEXGEN_CFG(53, XBAR_SRC_PLL4, 0, 5)
 		FLEXGEN_CFG(54, XBAR_SRC_PLL6, 0, 9)
 		FLEXGEN_CFG(55, XBAR_SRC_PLL6, 0, 9)
 		FLEXGEN_CFG(56, XBAR_SRC_PLL4, 0, 5)
diff --git a/core/arch/arm/dts/stm32mp257f-icore-edimm2-mx-rif.dtsi b/core/arch/arm/dts/stm32mp257f-icore-edimm2-mx-rif.dtsi
index 8fa7e3a4f..e11d43eef 100644
--- a/core/arch/arm/dts/stm32mp257f-icore-edimm2-mx-rif.dtsi
+++ b/core/arch/arm/dts/stm32mp257f-icore-edimm2-mx-rif.dtsi
@@ -77,7 +77,7 @@
 		RIFPROT(STM32MP25_RIFSC_SAI4_ID, EMPTY_SEMWL, RIF_UNLOCK, RIF_NSEC, RIF_NPRIV, RIF_UNUSED, RIF_SEM_EN, RIF_CFEN)
 		RIFPROT(STM32MP25_RIFSC_SDMMC1_ID, RIF_UNUSED, RIF_UNLOCK, RIF_NSEC, RIF_PRIV, RIF_CID1, RIF_SEM_DIS, RIF_CFEN)
 		RIFPROT(STM32MP25_RIFSC_SDMMC2_ID, RIF_UNUSED, RIF_UNLOCK, RIF_NSEC, RIF_PRIV, RIF_CID1, RIF_SEM_DIS, RIF_CFEN)
-		RIFPROT(STM32MP25_RIFSC_SDMMC3_ID, EMPTY_SEMWL, RIF_UNLOCK, RIF_NSEC, RIF_PRIV, RIF_UNUSED, RIF_SEM_EN, RIF_CFEN)
+		RIFPROT(STM32MP25_RIFSC_SDMMC3_ID, RIF_UNUSED, RIF_UNLOCK, RIF_NSEC, RIF_PRIV, RIF_CID1, RIF_SEM_DIS, RIF_CFEN)
 		RIFPROT(STM32MP25_RIFSC_SERC_ID, RIF_UNUSED, RIF_UNLOCK, RIF_SEC, RIF_PRIV, RIF_CID1, RIF_SEM_DIS, RIF_CFEN)
 		RIFPROT(STM32MP25_RIFSC_SPDIFRX_ID, EMPTY_SEMWL, RIF_UNLOCK, RIF_NSEC, RIF_NPRIV, RIF_UNUSED, RIF_SEM_EN, RIF_CFEN)
 		RIFPROT(STM32MP25_RIFSC_SPI1_ID, EMPTY_SEMWL, RIF_UNLOCK, RIF_NSEC, RIF_NPRIV, RIF_UNUSED, RIF_SEM_EN, RIF_CFEN)
@@ -515,7 +515,7 @@
 		RIFPROT(RIF_RCC_RESOURCE(50), EMPTY_SEMWL, RIF_UNLOCK, RIF_NSEC, RIF_PRIV, RIF_UNUSED, RIF_SEM_EN, RIF_CFEN) /* Feature = CK_KER_FMC */
 		RIFPROT(RIF_RCC_RESOURCE(51), RIF_UNUSED, RIF_UNLOCK, RIF_SEC, RIF_PRIV, RIF_CID1, RIF_SEM_DIS, RIF_CFEN) /* Feature = CK_KER_SDMMC1 */
 		RIFPROT(RIF_RCC_RESOURCE(52), RIF_UNUSED, RIF_UNLOCK, RIF_SEC, RIF_PRIV, RIF_CID1, RIF_SEM_DIS, RIF_CFEN) /* Feature = CK_KER_SDMMC2 */
-		RIFPROT(RIF_RCC_RESOURCE(53), EMPTY_SEMWL, RIF_UNLOCK, RIF_NSEC, RIF_PRIV, RIF_UNUSED, RIF_SEM_EN, RIF_CFEN) /* Feature = CK_KER_SDMMC3 */
+		RIFPROT(RIF_RCC_RESOURCE(53), RIF_UNUSED, RIF_UNLOCK, RIF_SEC, RIF_PRIV, RIF_CID1, RIF_SEM_DIS, RIF_CFEN) /* Feature = CK_KER_SDMMC3 */
 		RIFPROT(RIF_RCC_RESOURCE(54), RIF_UNUSED, RIF_UNLOCK, RIF_SEC, RIF_PRIV, RIF_CID1, RIF_SEM_DIS, RIF_CFEN) /* Feature = CK_KER_ETH1\nCK_KER_ETHSW */
 		RIFPROT(RIF_RCC_RESOURCE(55), RIF_UNUSED, RIF_UNLOCK, RIF_SEC, RIF_PRIV, RIF_CID1, RIF_SEM_DIS, RIF_CFEN) /* Feature = CK_KER_ETH2 */
 		RIFPROT(RIF_RCC_RESOURCE(56), RIF_UNUSED, RIF_UNLOCK, RIF_SEC, RIF_PRIV, RIF_CID1, RIF_SEM_DIS, RIF_CFEN) /* Feature = CK_KER_ETH1PTP\nCK_KER_ETH2PTP */
@@ -709,7 +709,7 @@
 		RIFPROT(RIF_EXTI1_RESOURCE(10), RIF_UNUSED, RIF_UNLOCK, RIF_NSEC, RIF_NPRIV, RIF_UNUSED, RIF_SEM_DIS, RIF_CFDIS) /* Feature = EXTI1[10] */
 		RIFPROT(RIF_EXTI1_RESOURCE(11), RIF_UNUSED, RIF_UNLOCK, RIF_NSEC, RIF_NPRIV, RIF_UNUSED, RIF_SEM_DIS, RIF_CFDIS) /* Feature = EXTI1[11] */
 		RIFPROT(RIF_EXTI1_RESOURCE(12), RIF_UNUSED, RIF_UNLOCK, RIF_NSEC, RIF_NPRIV, RIF_UNUSED, RIF_SEM_DIS, RIF_CFDIS) /* Feature = EXTI1[12] */
-		RIFPROT(RIF_EXTI1_RESOURCE(13), RIF_UNUSED, RIF_UNLOCK, RIF_NSEC, RIF_PRIV, RIF_CID1, RIF_SEM_DIS, RIF_CFEN) /* Feature = EXTI1[13] */
+		RIFPROT(RIF_EXTI1_RESOURCE(13), RIF_UNUSED, RIF_UNLOCK, RIF_NSEC, RIF_PRIV, RIF_UNUSED, RIF_SEM_DIS, RIF_CFDIS) /* Feature = EXTI1[13] */
 		RIFPROT(RIF_EXTI1_RESOURCE(14), RIF_UNUSED, RIF_UNLOCK, RIF_NSEC, RIF_NPRIV, RIF_UNUSED, RIF_SEM_DIS, RIF_CFDIS) /* Feature = EXTI1[14] */
 		RIFPROT(RIF_EXTI1_RESOURCE(15), RIF_UNUSED, RIF_UNLOCK, RIF_NSEC, RIF_NPRIV, RIF_UNUSED, RIF_SEM_DIS, RIF_CFDIS) /* Feature = EXTI1[15] */
 		RIFPROT(RIF_EXTI1_RESOURCE(16), RIF_UNUSED, RIF_UNLOCK, RIF_SEC, RIF_PRIV, RIF_CID1, RIF_SEM_DIS, RIF_CFEN) /* Feature = PVD */
@@ -872,7 +872,7 @@
 		RIFPROT(RIF_IOPORT_PIN(11), EMPTY_SEMWL,  RIF_UNLOCK, RIF_NSEC, RIF_PRIV, RIF_UNUSED, RIF_SEM_EN, RIF_CFEN) /* PD11 */
 		RIFPROT(RIF_IOPORT_PIN(12), RIF_UNUSED,  RIF_UNLOCK, RIF_NSEC, RIF_PRIV, RIF_CID1, RIF_SEM_DIS, RIF_CFEN) /* PD12 */
 		RIFPROT(RIF_IOPORT_PIN(13), RIF_UNUSED,  RIF_UNLOCK, RIF_NSEC, RIF_PRIV, RIF_CID1, RIF_SEM_DIS, RIF_CFEN) /* PD13 */
-		RIFPROT(RIF_IOPORT_PIN(14), EMPTY_SEMWL,  RIF_UNLOCK, RIF_NSEC, RIF_PRIV, RIF_UNUSED, RIF_SEM_EN, RIF_CFEN) /* PD14 */
+		RIFPROT(RIF_IOPORT_PIN(14), RIF_UNUSED,  RIF_UNLOCK, RIF_NSEC, RIF_PRIV, RIF_CID1, RIF_SEM_DIS, RIF_CFEN) /* PD14 */
 		RIFPROT(RIF_IOPORT_PIN(15), RIF_UNUSED,  RIF_UNLOCK, RIF_SEC, RIF_PRIV, RIF_CID1, RIF_SEM_DIS, RIF_CFEN) /* PD15 */
 	>;
 };
diff --git a/core/arch/arm/dts/stm32mp257f-icore-edimm2-mx.dts b/core/arch/arm/dts/stm32mp257f-icore-edimm2-mx.dts
index 7f3188267..19926f2a4 100644
--- a/core/arch/arm/dts/stm32mp257f-icore-edimm2-mx.dts
+++ b/core/arch/arm/dts/stm32mp257f-icore-edimm2-mx.dts
@@ -620,6 +620,12 @@
 	st,protreg = <RIFPROT(RIF_IOPORT_PIN(6), RIF_UNUSED,  RIF_UNLOCK, RIF_NSEC, RIF_NPRIV, RIF_UNUSED, RIF_SEM_DIS, RIF_CFDIS)>;
 };
 
-		
+&gpioc {
+	st,protreg = <RIFPROT(RIF_IOPORT_PIN(11), RIF_UNUSED,  RIF_UNLOCK, RIF_NSEC, RIF_PRIV, RIF_UNUSED, RIF_SEM_DIS, RIF_CFDIS)>;
+};
+
+&gpioi {
+	st,protreg = <RIFPROT(RIF_IOPORT_PIN(2), RIF_UNUSED,  RIF_UNLOCK, RIF_NSEC, RIF_PRIV, RIF_CID1, RIF_SEM_DIS, RIF_CFEN)>;
+};
 /* USER CODE END addons */
 
